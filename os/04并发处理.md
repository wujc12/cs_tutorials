# 第4章 并发处理

## 4.1 并发活动——进程的引入

操作系统的重要特性是并发和共享，计算机系统能同时存在两个及以上正在执行的程序。

### 4.1.1 程序的顺序执行

#### 数据、操作与计算

1. 数据：用来表示人们思维对象的抽象概念的物理表现；
2. 信息：经过解释和处理以满足特定需要的数据叫信息；
3. 操作：数据处理的规则叫做操作；
4. 计算：对某一有限数据对集合所施行的、目的在于解决某一问题的一组有限的操作的集合成为一个计算。

一个程序的执行过程就是一个计算。

#### 顺序程序

一个计算由若干个操作组成，而这些操作如果是顺序执行的。或者说一个程序由若干个程序段组成，而这些程序段的执行顺序必须是顺序的，则这个程序被称为顺序程序。

#### 顺序程序的特点

1. 顺序性；
2. 封闭性：程序一旦开始执行，其计算结果不受外界因素的影响；
3. 可再现性：程序执行的结果与它的执行速度无关，只与初始条件有关；

### 4.1.2 程序的并发执行

程序的并发执行指的是：若干个程序段同时在系统中运行，这些程序段的执行在时间上是重叠的，一个程序段的执行尚未结束，另一个程序段的执行已经开始，则这几个程序段是并发执行的。

### 4.1.3 并发实例——誊抄

略

### 4.1.4 与时间有关的错误

#### 什么是与时间有关的错误

程序并发执行时若共享了公共变量，其执行结果将与并发程序执行的相对速度有关，即给定相同的初始条件，也可能会得到不同的结果，此为与时间有关的错误。**因此，为了保证得到唯一正确的结果，需要实现并发程序执行时的互斥和同步。**

#### 与时间有关的错误产生的原因

若并发执行的程序共享某些公共变量，则一个程序的执行会改变另一个程序的变量。因此程序执行时，其输出结果将受外界影响而失去封闭性；同时结果也是不可再现的，这种现象说明程序并发执行时会发生与时间有关的错误。

### 4.1.5 并发程序的特点

#### 失去程序的封闭性

1. 如果一个程序的变量是其他程序执行时不可接触的，那么这个程序执行后的输出结果一定是其输入的一个与时间无关的函数，具有封闭性；
2. 如果一个程序的执行可以改变另一个程序的变量，那么，后者的输出就可能有赖于各程序执行的相对速度，也就是失去了程序的封闭性特点。

#### 程序与计算不再一一对应

程序在顺序执行时，与计算有一一对应关系，但在并发执行时，这种关系就不再存在了。

#### 程序并发执行的相互制约

当并发执行的各程序之间需要协同操作来完成一个共同的任务时，它们之间具有直接的相互制约关系，且这样的程序之间有一定的逻辑关系。

## 4.2 进程概念

### 4.2.1 进程的定义

下面是集中能反映进程实质的定义：

1. 进程是这样的计算部分，它是可以和其他计算并行的一个计算；
2. 进程（有时称为任务）是一个程序与其数据一道痛殴处理机的执行所发生的活动过；
3. 进程是由一个计算机以及与它相关的状态信息所组成的；
4. 所谓进程，就是一个程序在给定活动空间和初始环境下，在一个处理机上的执行过程。

进程和程序的区别：

1. 程序是指令的有序集合，静态概念；而进程是程序在处理机上的一次执行过程，动态概念；
2. 进程是一个能独立运行的单位，能与其他程序并行地活动；
3. 进程是**竞争计算机系统有限资源的基本单位，也是进行处理机调度的基本单位**。

### 4.2.2 进程的类型

1. 系统进程：
2. 用户进程：

### 4.2.3 进程的状态

#### 进程的基本状态

1. 运行状态：进程由调度/分派模块分派后，得到中央处理机控制权，程序正在运行；
2. 就绪状态：进程获得了除CPU之外的所有资源，处于就绪状态；
3. 等待状态：进程正在等待某一事件发生（等待输入/IO操作完成），进程处于等待状态，或称之为**阻塞状态**。

### 4.2.4 进程的描述———进程控制块

为了描述一个进程和其他进程以及系统资源的关系，为了刻画一个进程在各个不同时期所处的状态，人们采用了一个与进程相联系的数据块，称为进程控制块（process control block, PCB）或称为进程描述器。**从结构上说，每个进程都由一个程序段和一个进程控制块组成。**

进程控制快应具有的信息包括：

1. 进程标识符name；
2. 进程的当前状态status；为了便于对进程实施管理，通常把具有相同状态的进程链在一起组成各种队列；
3. 当前队列指针next；
4. 总链指针all_q_next；
5. 程序开始地址start_addr；
6. 进程的优先级priority；
7. CPU现场保护区cpustatus；
8. 通信信息communication information；
9. 家族联系process family；
10. 占有资源清单own_resource。

### 4.2.5 线程概念及特点

#### 什么是线程

为了进一步提高系统的并行处理能力，出现了线程（threads）的概念。

线程是比进程更小的活动单位，它是进程中的一个**执行路径**。一个进程可以有多条执行路线，也即线程。

线程可以描述为：

1. 线程是进程中的一条执行路径；
2. 它有自己私有的堆栈和处理机执行环境；
3. 它共享分配给父进程的主存；
4. 它是单个进程所创建的许多个同时存在的线程中的一个。

进程可以高度概括为以下几个方面：

1. 一个可执行程序，定义了初始代码和数据；
2. 一个私用地址空间，它是进程可以使用的一组虚拟主存地址；
3. 进程执行时所需的系统资源，是由操作系统分配给进程的；
4. 若系统支持线程运行，那么每个进程至少有一个执行线程。

进程是任务调度的单位，也是**系统资源的分配单位**；而线程是进程中的一条执行路径，当系统支持多线程处理时，线程是**任务调度的单位**，但不是系统资源的分配单位。

#### 线程的特点与状态

## 4.3 进程控制
## 4.4 进程的相互制约关系
## 4.5 同步机构
## 4.6 进程互斥与同步的实现
## 4.7 UNIX系统的进程管理
